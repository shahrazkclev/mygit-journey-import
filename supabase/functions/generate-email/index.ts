import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.52.1'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface EmailGenerationRequest {
  prompt: string;
  subject: string;
  styleGuide?: {
    brandName: string;
    primaryColor: string;
    secondaryColor: string;
    accentColor: string;
    fontFamily: string;
    tone: string;
    brandVoice: string;
    emailSignature: string;
  };
}

Deno.serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Initialize Supabase client
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // Get user from auth header
    const authHeader = req.headers.get('Authorization');
    if (!authHeader) {
      throw new Error('No authorization header');
    }

    const { data: { user }, error: authError } = await supabase.auth.getUser(
      authHeader.replace('Bearer ', '')
    );

    if (authError || !user) {
      throw new Error('Invalid authentication');
    }

    const { prompt, subject, styleGuide }: EmailGenerationRequest = await req.json();

    if (!prompt || !subject) {
      throw new Error('Missing required fields: prompt and subject');
    }

    // Get Claude API key from secrets
    const claudeApiKey = Deno.env.get('CLAUDE_API_KEY');
    if (!claudeApiKey) {
      throw new Error('Claude API key not configured');
    }

    // Prepare the prompt for Claude
    const systemPrompt = `You are an expert email marketing copywriter. Create a professional, engaging HTML email template based on the user's requirements. 

Style Guidelines:
- Brand Name: ${styleGuide?.brandName || 'Your Brand'}
- Primary Color: ${styleGuide?.primaryColor || '#684cff'}
- Secondary Color: ${styleGuide?.secondaryColor || '#22d3ee'}
- Accent Color: ${styleGuide?.accentColor || '#34d399'}
- Font Family: ${styleGuide?.fontFamily || 'Segoe UI, sans-serif'}
- Tone: ${styleGuide?.tone || 'friendly'}
- Brand Voice: ${styleGuide?.brandVoice || 'Professional yet approachable'}

Requirements:
1. Create a complete HTML email template with embedded CSS
2. Use EXACTLY these colors: Primary: ${styleGuide?.primaryColor || '#684cff'}, Secondary: ${styleGuide?.secondaryColor || '#22d3ee'}, Accent: ${styleGuide?.accentColor || '#34d399'}
3. Apply the primary color to headers and main CTA buttons
4. Apply the secondary color to secondary elements and backgrounds
5. Apply the accent color to highlights and hover states
6. Include proper email structure (header, content, footer)
7. Add placeholder variables: {{name}}, {{unsubscribe_url}}
8. Make it mobile-responsive
9. Include a clear call-to-action button using the primary color
10. Use the specified tone and brand voice
11. Add the email signature: ${styleGuide?.emailSignature || 'Best regards,\\nThe Team'}

Return only the HTML code, no explanations.`;

    const userPrompt = `Create an email with subject "${subject}" based on this prompt: ${prompt}`;

    // Call Claude API
    const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': claudeApiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-3-sonnet-20240229',
        max_tokens: 4000,
        messages: [
          {
            role: 'user',
            content: `${systemPrompt}\n\n${userPrompt}`
          }
        ],
      }),
    });

    if (!claudeResponse.ok) {
      const errorText = await claudeResponse.text();
      console.error('Claude API error:', errorText);
      throw new Error(`Claude API error: ${claudeResponse.status}`);
    }

    const claudeData = await claudeResponse.json();
    const generatedHtml = claudeData.content[0]?.text || '';

    if (!generatedHtml) {
      throw new Error('No content generated by Claude');
    }

    // Log the successful generation
    console.log('Email template generated successfully for user:', user.id);

    return new Response(
      JSON.stringify({
        success: true,
        htmlContent: generatedHtml,
        metadata: {
          subject,
          userId: user.id,
          generatedAt: new Date().toISOString(),
        }
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    );

  } catch (error) {
    console.error('Error in generate-email function:', error);
    
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message || 'Internal server error',
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500,
      }
    );
  }
});