import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.52.1'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface EmailGenerationRequest {
  prompt: string;
  subject: string;
  styleGuide?: {
    brandName: string;
    primaryColor: string;
    secondaryColor: string;
    accentColor: string;
    fontFamily: string;
    tone: string;
    brandVoice: string;
    emailSignature: string;
  };
}

Deno.serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Initialize Supabase client
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // Skip authentication for demo purposes
    const demoUserId = '550e8400-e29b-41d4-a716-446655440000';

    const { prompt, subject, styleGuide }: EmailGenerationRequest = await req.json();

    if (!prompt || !subject) {
      throw new Error('Missing required fields: prompt and subject');
    }

    // Get Claude API key from secrets
    const claudeApiKey = Deno.env.get('CLAUDE_API_KEY');
    if (!claudeApiKey) {
      throw new Error('Claude API key not configured');
    }

    // Prepare the prompt for Claude
    const systemPrompt = `You are creating a professional email for a business. Write naturally as if a human is communicating directly with another person. 

Brand Style:
- Brand: ${styleGuide?.brandName || 'Your Brand'}  
- Colors: Primary ${styleGuide?.primaryColor || '#684cff'}, Secondary ${styleGuide?.secondaryColor || '#22d3ee'}, Accent ${styleGuide?.accentColor || '#34d399'}
- Font: ${styleGuide?.fontFamily || 'Arial, sans-serif'}
- Voice: ${styleGuide?.tone || 'friendly'} and ${styleGuide?.brandVoice || 'professional'}

Create a simple, clean HTML email that:
1. Uses a subtle gradient background with the brand colors
2. Has a clean white content area with simple styling  
3. Includes {{name}} and {{unsubscribe_url}} placeholders
4. Ends with: ${styleGuide?.emailSignature || 'Best regards,\\nThe Team'}
5. Sounds natural and human - avoid corporate jargon
6. Keep styling minimal and elegant

Return only clean HTML code.`;

    const userPrompt = `Subject: "${subject}" - Write about: ${prompt}`;

    // Call Claude API
    const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': claudeApiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-3-sonnet-20240229',
        max_tokens: 4000,
        messages: [
          {
            role: 'user',
            content: `${systemPrompt}\n\n${userPrompt}`
          }
        ],
      }),
    });

    if (!claudeResponse.ok) {
      const errorText = await claudeResponse.text();
      console.error('Claude API error:', errorText);
      throw new Error(`Claude API error: ${claudeResponse.status}`);
    }

    const claudeData = await claudeResponse.json();
    const generatedHtml = claudeData.content[0]?.text || '';

    if (!generatedHtml) {
      throw new Error('No content generated by Claude');
    }

    // Log the successful generation
    console.log('Email template generated successfully');

    return new Response(
      JSON.stringify({
        success: true,
        htmlContent: generatedHtml,
        metadata: {
          subject,
          userId: demoUserId,
          generatedAt: new Date().toISOString(),
        }
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    );

  } catch (error) {
    console.error('Error in generate-email function:', error);
    
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message || 'Internal server error',
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500,
      }
    );
  }
});