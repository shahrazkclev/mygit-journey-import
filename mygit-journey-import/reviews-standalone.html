<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Review Cards</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
    /* Reset and base styles */
    * { box-sizing: border-box; }
    
    /* Container - compact height */
    .reviews-container {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        position: relative;
        height: auto;
        min-height: auto;
    }
    
    /* Carousel - compact */
    .reviews-carousel {
        display: flex;
        gap: 1rem;
        padding: 0.5rem;
        overflow-x: auto; /* Enable scroll on desktop */
        scroll-behavior: smooth;
        scrollbar-width: none;
        -ms-overflow-style: none;
        cursor: default; /* No grab cursor on desktop */
        flex-wrap: nowrap; /* Keep cards in a row */
    }
    
    .reviews-carousel:active {
        cursor: grabbing;
    }
    
    .reviews-carousel::-webkit-scrollbar {
        display: none;
    }
    
    /* Cards */
    .review-card {
        flex: 0 0 16rem;
        height: 24rem;
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
        background: #f3f4f6;
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 1;
    }
    
    .review-card.fade-in {
        animation: fadeInCard 0.5s ease-in-out;
    }
    
    @keyframes fadeInCard {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .review-card:hover {
        transform: scale(1.02);
    }
    
    /* Media */
    .media-container {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
    }
    
    .media-thumbnail,
    .media-video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .media-video {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .review-card:hover .media-video {
        opacity: 1;
    }
    
    /* Content overlay */
    .content-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 1rem;
        color: white;
    }
    
    
    /* Loading states */
    .loading-skeleton {
        background: linear-gradient(90deg, #c2c2b1 25%, #a8a896 50%, #c2c2b1 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .loading-dots {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .loading-dots.visible {
        opacity: 1;
    }
    
    .loading-dot {
        width: 0.5rem;
        height: 0.5rem;
        background: rgba(255,255,255,0.8);
        border-radius: 50%;
        animation: dot-pulse 1.4s infinite;
    }
    
    .loading-dot:nth-child(1) { animation-delay: 0s; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes dot-pulse {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1.2); opacity: 1; }
    }
    
    /* Controls */
    .mute-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0,0,0,0.3);
        border: none;
        border-radius: 50%;
        color: white;
        padding: 0.5rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .review-card:hover .mute-btn {
        opacity: 1;
    }
    
    .play-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        color: white;
        cursor: pointer;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 20;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .play-btn svg {
        margin-left: 10px;
        margin-top: 1px;
    }
    
    .play-btn.visible {
        opacity: 1;
    }
    
    /* Hide play button on desktop */
    @media (min-width: 769px) {
        .play-btn {
            display: none !important;
        }
    }
    
    /* Show play button on mobile */
    @media (max-width: 768px) {
        .play-btn {
            display: block !important;
            opacity: 0.8; /* Subtle visibility on mobile */
        }
        
        .play-btn:hover {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.05);
        }
    }
    
    /* Text */
    .review-text-container {
        margin-bottom: 0.25rem;
        margin-top: 0;
    }
    
    .review-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        margin-bottom: 0;
    }
    
    .review-text.expanded {
        -webkit-line-clamp: unset;
        line-clamp: unset;
        font-size: 0.875rem; /* Scale down from base size */
        line-height: 1.3; /* Tighter line height for more text */
        max-height: none; /* No height limit on desktop */
        overflow-y: visible; /* No scrolling on desktop */
    }
    
    .expand-btn {
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0;
        margin-top: 0.25rem;
        display: block;
        text-align: left;
    }
    
    .expand-btn:hover {
        color: white;
    }
    
    /* Improved visibility when expanded */
    .review-card.expanded .content-overlay {
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 30%, transparent 70%);
    }
    
    .review-card.expanded .review-text {
        background: rgba(0,0,0,0.3);
        padding: 0.5rem;
        border-radius: 0.5rem;
        backdrop-filter: blur(4px);
    }
    
    
    /* Profile picture fixes */
    .review-card img[alt="Profile"] {
        object-fit: cover !important;
        object-position: center !important;
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        min-width: 0 !important;
        min-height: 0 !important;
        border-radius: 50% !important;
        display: block !important;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .review-card {
            flex: 0 0 14rem;
            height: 20rem;
        }
        
        .reviews-carousel {
            padding: 0.5rem 0.25rem;
            overflow-x: auto; /* Enable scroll on mobile */
            cursor: grab; /* Grab cursor on mobile */
        }
        
        .reviews-carousel:active {
            cursor: grabbing;
        }
        
        /* Mobile: Allow scrolling for expanded text */
        .review-text.expanded {
            max-height: 6rem; /* Limit height on mobile */
            overflow-y: auto; /* Allow scrolling on mobile */
        }
    }
</style>
</head>
<body>
<div class="reviews-container">
    <!-- Reviews Content with Skeletons -->
    <div id="reviews-content" class="reviews-carousel">
        <!-- Skeleton cards - always visible initially -->
        <div class="review-card loading-skeleton"></div>
        <div class="review-card loading-skeleton"></div>
        <div class="review-card loading-skeleton"></div>
        <div class="review-card loading-skeleton"></div>
        <div class="review-card loading-skeleton"></div>
    </div>
    
</div>

<script>
    // Configuration
    const CONFIG = {
        supabaseUrl: "https://mixifcnokcmxarpzwfiy.supabase.co",
        supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1peGlmY25va2NteGFycHp3Zml5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NjYwNTEsImV4cCI6MjA2OTA0MjA1MX0.-4uIuzcHcDGS20-dtKbjVFOtpBSmwYhT9Bgt6KA-dXI",
        timeout: 10000,
        maxReviews: 20
    };

    // State
    let supabaseClient = null;
    let isUnmuted = false;
    let loadedVideos = new Set();
    let isLoading = false;
    
    // Initialize Supabase
    function initSupabase() {
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
            return true;
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            return false;
        }
    }

    // Utility functions
    function getInitials(name) {
        return name ? name.charAt(0).toUpperCase() : 'U';
    }
    
    function getGradient(name) {
        const colors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
        ];
        const hash = name ? name.split('').reduce((a, b) => a + b.charCodeAt(0), 0) : 0;
        return colors[hash % colors.length];
    }
    
    function renderStars(rating) {
        return Array.from({ length: 5 }, (_, i) => 
            `<span class="text-yellow-400">${i < rating ? '★' : '☆'}</span>`
        ).join('');
    }

    // Create review card HTML
    function createReviewCard(review) {
        const initials = getInitials(review.user_name);
        const gradient = getGradient(review.user_name);
        const stars = renderStars(review.rating);
        const mediaUrl = review.media_url_optimized || review.media_url;
        const thumbnailUrl = review.thumbnail_url || review.media_url;
        const isVideo = review.media_type === 'video';
        
        // Debug: Log description length and content
        const description = review.description || review.text || review.content || '';
        console.log(`Review ${review.id}:`, {
            description: description,
            length: description.length,
            hasMoreButton: description.length > 80,
            allFields: Object.keys(review)
        });
        
        return `
            <div class="review-card" data-review-id="${review.id}" data-media-url="${mediaUrl}" data-media-type="${review.media_type}">
                <div class="media-container">
                    <img src="${thumbnailUrl}" alt="Review thumbnail" class="media-thumbnail" onerror="this.style.display='none'">
                    ${isVideo ? `<video class="media-video" muted loop playsinline preload="none"><source src="${mediaUrl}" type="video/mp4"></video>` : ''}
                </div>
                
                <div class="content-overlay">
                    <div class="review-text-container">
                        <p class="review-text">"${description}"</p>
                        ${description.length > 80 ? '<button class="expand-btn">more</button>' : ''}
                    </div>
                    <div class="flex items-center gap-1 mb-1">${stars}</div>
                    <div class="flex items-center gap-2" style="min-width: 0;">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold overflow-hidden flex-shrink-0" style="background: ${gradient}">
                            ${review.user_avatar ? `<img src="${review.user_avatar}" alt="Profile" style="width: 32px; height: 32px; object-fit: cover; object-position: center; border-radius: 50%; display: block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><span style="display: none;">${initials}</span>` : initials}
                        </div>
                        <a href="https://instagram.com/${review.user_instagram_handle.replace('@', '')}" target="_blank" class="text-white hover:text-blue-300 transition-colors truncate" style="font-size: 0.75rem; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">
                            ${review.user_instagram_handle}
                        </a>
                    </div>
                </div>
                
                ${isVideo ? `
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <button class="play-btn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <button class="mute-btn" style="display: none;">
                        <svg class="mute-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                        <svg class="unmute-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="display: none;">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
        `;
    }

    // Load reviews from Supabase
    async function loadReviews() {
        if (isLoading) return;
        isLoading = true;
        
        try {
            if (!supabaseClient) {
                throw new Error('Supabase not initialized');
            }
            
            const { data, error } = await supabaseClient
                .from('reviews')
                .select('*')
                .eq('is_active', true)
                .order('sort_order', { ascending: true, nullsFirst: true })
                .order('created_at', { ascending: false })
                .limit(CONFIG.maxReviews);
            
            if (error) throw error;
            
            if (!data || data.length === 0) {
                showError();
                return;
            }
            
            // Filter for lazy motion tag client-side (since server-side filtering might not work)
            const filteredData = data.filter(review => 
                review.tags && review.tags.includes('lazy motion')
            );
            
            // Debug: Log the data before sorting
            console.log('Raw data from Supabase:', data.map(r => ({
                user_name: r.user_name,
                sort_order: r.sort_order,
                created_at: r.created_at,
                tags: r.tags
            })));
            
            console.log('Filtered data (lazy motion only):', filteredData.map(r => ({
                user_name: r.user_name,
                sort_order: r.sort_order,
                created_at: r.created_at
            })));
            
            // Sort client-side: sort_order represents POSITION (1st, 2nd, 3rd, etc.)
            filteredData.sort((a, b) => {
                const aSort = a.sort_order ?? 999999; // No sort_order = appears last
                const bSort = b.sort_order ?? 999999;
                
                // Sort by position number (1, 2, 3, 4, 5...)
                if (aSort !== bSort) return aSort - bSort;
                
                // Same sort_order, sort by created_at (newest first)
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            // Debug: Log the data after sorting
            console.log('Data after sorting:', filteredData.map(r => ({
                user_name: r.user_name,
                sort_order: r.sort_order,
                created_at: r.created_at
            })));
            
            displayReviews(filteredData);
            
        } catch (error) {
            console.error('Failed to load reviews:', error);
            showError();
        } finally {
            isLoading = false;
        }
    }
    
    // Display reviews
    function displayReviews(reviews) {
        const container = document.getElementById('reviews-content');
        
        // Replace skeleton cards with actual review cards
        container.innerHTML = reviews.map(createReviewCard).join('');
        
        // Add fade-in animation to new cards
        setTimeout(() => {
            const cards = container.querySelectorAll('.review-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100); // Stagger the animation
            });
        }, 50);
        
        // Initialize interactions
        initializeInteractions();
    }
    
    // Show error state - just keep skeleton cards
    function showError() {
        const container = document.getElementById('reviews-content');
        
        // Keep skeleton cards visible
        container.innerHTML = `
            <div class="review-card loading-skeleton"></div>
            <div class="review-card loading-skeleton"></div>
            <div class="review-card loading-skeleton"></div>
            <div class="review-card loading-skeleton"></div>
            <div class="review-card loading-skeleton"></div>
        `;
    }
    
    // Initialize card interactions
    function initializeInteractions() {
        const cards = document.querySelectorAll('.review-card');
        const carousel = document.getElementById('reviews-content');
        
        // Enable wheel scrolling on both desktop and mobile
        if (carousel) {
            carousel.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    carousel.scrollLeft += e.deltaY * 2; // 2x faster scroll
                }
            });
        }
        
        // Only enable drag scrolling on mobile
        const isMobile = window.innerWidth <= 768;
        
        if (carousel && isMobile) {
            // Add drag scrolling
            let isDown = false;
            let startX;
            let scrollLeft;
            
            carousel.addEventListener('mousedown', (e) => {
            isDown = true; 
                carousel.style.cursor = 'grabbing';
                startX = e.pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
            });
            
            carousel.addEventListener('mouseleave', () => {
            isDown = false; 
                carousel.style.cursor = 'grab';
        });
        
            carousel.addEventListener('mouseup', () => {
            isDown = false; 
                carousel.style.cursor = 'grab';
        });
        
            carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return; 
            e.preventDefault(); 
                const x = e.pageX - carousel.offsetLeft;
                const walk = (x - startX) * 2; // 2x faster drag
                carousel.scrollLeft = scrollLeft - walk;
            });
        }
        
        cards.forEach(card => {
            const video = card.querySelector('video');
            const muteBtn = card.querySelector('.mute-btn');
            const playBtn = card.querySelector('.play-btn');
            const loadingDots = card.querySelector('.loading-dots');
            const expandBtn = card.querySelector('.expand-btn');
            const reviewText = card.querySelector('.review-text');
            const isMobile = window.innerWidth <= 768;
            
            // Video interactions
            if (video) {
                // Desktop hover interactions
                if (!isMobile) {
                    card.addEventListener('mouseenter', () => {
                        if (!loadedVideos.has(card.dataset.reviewId)) {
                            loadingDots.classList.add('visible');
                            video.load();
        video.addEventListener('loadeddata', () => {
                                loadingDots.classList.remove('visible');
                                muteBtn.style.display = 'block';
                                loadedVideos.add(card.dataset.reviewId);
                            }, { once: true });
                        }
                        video.play().catch(() => {});
                    });
                    
                    card.addEventListener('mouseleave', () => {
                        video.pause();
                    });
                }
                
                // Mobile click interactions
                if (isMobile) {
                    card.addEventListener('click', (e) => {
                        // Don't trigger if clicking on links
                        if (e.target.closest('a')) return;
                        
                        if (video.paused) {
                            // Load video if not loaded
                            if (!loadedVideos.has(card.dataset.reviewId)) {
                                loadingDots.classList.add('visible');
                                playBtn.style.opacity = '0'; // Hide play button while loading
                                video.load();
                                video.addEventListener('loadeddata', () => {
                                    loadingDots.classList.remove('visible');
                                    playBtn.style.opacity = '0'; // Keep hidden when playing
                                    loadedVideos.add(card.dataset.reviewId);
                                }, { once: true });
                            } else {
                                playBtn.style.opacity = '0'; // Hide play button when playing
                            }
                            
                            // Unmute and play
                            isUnmuted = true;
                            video.muted = false;
                            updateMuteButtons();
                            
                            // Pause other videos and show their play buttons
                            document.querySelectorAll('.review-card video').forEach(otherVideo => {
                                if (otherVideo !== video) {
                                    otherVideo.pause();
                                    const otherPlayBtn = otherVideo.closest('.review-card').querySelector('.play-btn');
                                    if (otherPlayBtn) otherPlayBtn.style.opacity = '0.8';
                                }
                            });
                            
                            video.play().catch(() => {});
                        } else {
                            video.pause();
                            playBtn.style.opacity = '0.8'; // Show play button when paused
                        }
                    });
                }
                
                // Mute button
        if (muteBtn) {
            muteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                        isUnmuted = !isUnmuted;
                        video.muted = !isUnmuted;
                        updateMuteButtons();
                    });
                }
            }
            
            // Text expansion
            if (expandBtn && reviewText) {
                expandBtn.addEventListener('click', () => {
                    const isExpanded = reviewText.classList.contains('expanded');
                    reviewText.classList.toggle('expanded');
                    card.classList.toggle('expanded');
                    expandBtn.textContent = isExpanded ? 'more' : 'less';
                    
                    // Adjust font size for expanded text to fit within card bounds
                    if (!isExpanded) {
                        adjustExpandedTextSize(reviewText);
                    }
                });
            }
        });
    }
    
    // Adjust expanded text size to fit within card bounds (mobile only)
    function adjustExpandedTextSize(textElement) {
        const isMobile = window.innerWidth <= 768;
        
        // Only adjust on mobile
        if (!isMobile) return;
        
        const card = textElement.closest('.review-card');
        const cardHeight = card.offsetHeight;
        const availableHeight = cardHeight - 120; // Reserve space for stars and profile
        
        // Reset font size to base
        textElement.style.fontSize = '';
        
        // Check if text overflows
        if (textElement.scrollHeight > availableHeight) {
            let fontSize = 0.875; // Start with 0.875rem
            
            // Gradually reduce font size until it fits
            while (textElement.scrollHeight > availableHeight && fontSize > 0.6) {
                fontSize -= 0.05;
                textElement.style.fontSize = `${fontSize}rem`;
            }
        }
    }
    
    // Update all mute buttons
    function updateMuteButtons() {
        document.querySelectorAll('.mute-btn').forEach(btn => {
            const video = btn.closest('.review-card').querySelector('video');
            const muteIcon = btn.querySelector('.mute-icon');
            const unmuteIcon = btn.querySelector('.unmute-icon');
            
            if (video) {
                video.muted = !isUnmuted;
                
                // Update icon visibility
                if (isUnmuted) {
                    muteIcon.style.display = 'none';
                    unmuteIcon.style.display = 'block';
    } else {
                    muteIcon.style.display = 'block';
                    unmuteIcon.style.display = 'none';
                }
            }
        });
    }
    
    // Initialize everything
    function init() {
        if (!initSupabase()) {
            showError();
            return;
        }
        
        loadReviews();
    }
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
        } else {
        init();
    }

</script>
</body>
</html>